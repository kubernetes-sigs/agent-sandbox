name: performance-churn-test-steady-state
automanagedNamespaces: 0

tuningSets:
- name: ConstantChurn
  qpsLoad:
    qps: 2  # 2 constant sandbox creation and deletion per second
- name: QuickFinalDeletion
  qpsLoad:
    qps: 100  # 100 sandbox deletions per second for final cleanup

steps:
# 1. Initial Warmup to establish steady state for Group A
- name: Initial Warmup
  phases:
  - namespaceRange: {min: 1, max: 1}
    replicasPerNamespace: 1200
    tuningSet: ConstantChurn
    objectBundle:
    - basename: churn-warmup-group
      objectTemplatePath: cluster-loader-sandbox.yaml
      templateFillMap:
        Group: warmup-group
    waits:
    - type: Running
      labelSelector: "agents.x-k8s.io/sandbox-name-hash"

# # 2. Start Measurements for Group B sandbox creations
- name: Start Measurements
  measurements:
  - identifier: PodStartupLatency
    method: PodStartupLatency
    params:
      action: start
      labelSelector: "churn-group=continuous-churn-group"

# # 3. Create Continuous Churn Loop with sandboxes getting created 
# # in Group B while sandboxes in Group A are getting deleted concurrently 
# # to maintain steady state.
- name: Continuous Churn Cycle
  phases:
  - name: Create
    namespaceRange: {min: 1, max: 1}
    replicasPerNamespace: 1200
    tuningSet: ConstantChurn
    objectBundle:
    - basename: churn-continuous-churn-group
      objectTemplatePath: cluster-loader-sandbox.yaml
      templateFillMap:
        Group: continuous-churn-group
    waits:
    - type: Running
      labelSelector: "agents.x-k8s.io/sandbox-name-hash"
  - name: Delete
    namespaceRange: {min: 1, max: 1}
    replicasPerNamespace: 0
    tuningSet: ConstantChurn
    objectBundle:
    - basename: churn-warmup-group
      objectTemplatePath: cluster-loader-sandbox.yaml
    waits:
    - type: Deleted
      labelSelector: "churn-group=warmup-group"

# # 4. Gather Measurements for Group B sandbox creations
- name: Gather Measurements
  measurements:
  - identifier: PodStartupLatency
    method: PodStartupLatency
    params:
      action: gather
      labelSelector: "churn-group=continuous-churn-group"

# 5. Cleanup any remaining Sandboxes to keep the cluster clean
- name: Cleanup Remaining Sandboxes
  phases:
  - namespaceRange: {min: 1, max: 1}
    replicasPerNamespace: 0
    tuningSet: ConstantChurn
    objectBundle:
    - basename: churn-warmup-group
      objectTemplatePath: cluster-loader-sandbox.yaml
  - namespaceRange: {min: 1, max: 1}
    replicasPerNamespace: 0
    tuningSet: QuickFinalDeletion
    objectBundle:
    - basename: churn-continuous-churn-group
      objectTemplatePath: cluster-loader-sandbox.yaml