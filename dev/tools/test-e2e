#!/usr/bin/env python3
# Copyright 2025 The Kubernetes Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import os
import argparse
import platform
import shutil
import subprocess
import sys
import tarfile
import urllib.request

from shared import utils


def run_go_e2e_tests(repo_root, artifact_dir, env):
    """Runs the Go e2e tests"""
    print("========= Running Go E2E tests... =========")
    go_test_cmd = utils.go_tool_args(
        "gotestsum",
        f"--junitfile={repo_root}/bin/e2e-go-junit.xml",
        f"--jsonfile={artifact_dir}/test-e2e.json",
        "--",
        "./test/e2e/...",
        "--parallel=1",
        "-v",
    )
    print(f"Running command: {' '.join(go_test_cmd)}")
    return subprocess.run(go_test_cmd, env=env, cwd=repo_root).returncode


def run_go_e2e_benchmarks(repo_root, artifact_dir, env):
    """Runs the Go e2e benchmarks and saves output for benchstat"""
    print("========= Running Go E2E benchmarks... =========")
    benchmark_file = os.path.join(artifact_dir, "benchmarks-go.txt")

    # Run benchmarks with go test directly (not gotestsum) to get clean benchmark output
    go_test_cmd = [
        "go", "test",
        "-bench=.",
        "-benchtime=1x",  # Run each benchmark once (e2e tests are expensive)
        "-run=^$",  # Don't run tests, only benchmarks
        "./test/e2e/...",
    ]
    print(f"Running command: {' '.join(go_test_cmd)}")
    print(f"Benchmark output will be saved to: {benchmark_file}")

    with open(benchmark_file, "w") as f:
        process = subprocess.Popen(go_test_cmd, env=env, cwd=repo_root, stdout=subprocess.PIPE, text=True)

        for line in process.stdout:
            sys.stdout.write(line)  # Print to terminal as it happens
            f.write(line)           # Save to file also

        process.wait()

    return process.returncode


def setup_python_sdk(repo_root, env):
    """Installs the Python SDK and its dependencies"""
    print("========= Ensuring Python SDK is installed... =========")
    venv_path = os.path.join(repo_root, ".venv")
    sdk_path = os.path.join(repo_root, "clients", "python", "agentic-sandbox-client")

    # Create virtual environment
    print(f"Creating virtual environment at {venv_path}")
    result = subprocess.run(
        [sys.executable, "-m", "venv", venv_path], env=env, cwd=repo_root, check=False
    )
    if result.returncode != 0:
        print("Failed to create virtual environment.")
        return False

    # Install in editable mode within the virtual environment
    pip_executable = os.path.join(venv_path, "bin", "pip")
    install_cmd = [pip_executable, "install", "-e", f"{sdk_path}[test]"]
    # Install in editable mode
    print(f"Running command: {' '.join(install_cmd)}")
    result = subprocess.run(install_cmd, env=env, cwd=repo_root, check=False)
    if result.returncode != 0:
        print("Failed to install Python SDK.")
        return False
    print("Python SDK installed successfully.")
    return True


def install_node(install_dir):
    """Downloads and installs Node.js to the specified directory."""
    print(f"Installing Node.js to {install_dir}...")
    if os.path.exists(install_dir):
        shutil.rmtree(install_dir)
    os.makedirs(install_dir)

    system = platform.system().lower()
    machine = platform.machine().lower()

    if system == "linux":
        os_name = "linux"
    elif system == "darwin":
        os_name = "darwin"
    else:
        print(f"Warning: Unsupported OS for auto-install: {system}")
        return None

    if machine in ["x86_64", "amd64"]:
        arch = "x64"
    elif machine in ["aarch64", "arm64"]:
        arch = "arm64"
    else:
        print(f"Warning: Unsupported architecture for auto-install: {machine}")
        return None

    version = "v22.22.0"
    filename = f"node-{version}-{os_name}-{arch}.tar.gz"
    url = f"https://nodejs.org/dist/{version}/{filename}"

    print(f"Downloading {url}...")
    tar_path = os.path.join(install_dir, filename)
    try:
        urllib.request.urlretrieve(url, tar_path)
    except Exception as e:
        print(f"Failed to download Node.js: {e}")
        return None

    print(f"Extracting {tar_path}...")
    try:
        with tarfile.open(tar_path, "r:gz") as tar:
            tar.extractall(path=install_dir)
    except Exception as e:
        print(f"Failed to extract Node.js: {e}")
        return None

    # The tarball creates a subdirectory, e.g., node-v22.13.0-linux-x64
    extracted_dir = os.path.join(install_dir, filename.replace(".tar.gz", ""))
    bin_dir = os.path.join(extracted_dir, "bin")

    if not os.path.exists(bin_dir):
        print(f"Error: expected bin directory not found at {bin_dir}")
        return None

    return bin_dir


def setup_typescript_sdk(repo_root, env):
    """Installs the TypeScript SDK dependencies and builds it"""
    print("========= Ensuring TypeScript SDK is built... =========")

    # Check if npm is available in PATH
    npm_path = shutil.which("npm")

    if npm_path:
        print(f"Using system npm: {npm_path}")
    else:
        print("npm not found in PATH.")
        # Check if we already have it installed locally
        node_install_dir = os.path.join(repo_root, ".node")

        # Let's try to locate the bin directory inside .node if it exists
        found_bin = None
        if os.path.exists(node_install_dir):
            for item in os.listdir(node_install_dir):
                 candidate = os.path.join(node_install_dir, item, "bin")
                 if os.path.isdir(candidate) and os.path.exists(os.path.join(candidate, "node")):
                     found_bin = candidate
                     break

        if found_bin:
             print(f"Using locally installed Node.js at {found_bin}")
             env["PATH"] = f"{found_bin}:{env.get('PATH', '')}"
        else:
             print("Installing Node.js locally...")
             bin_dir = install_node(node_install_dir)
             if not bin_dir:
                 print("Failed to install Node.js locally.")
                 return False
             env["PATH"] = f"{bin_dir}:{env.get('PATH', '')}"

    # Verify installation
    try:
        node_version = subprocess.run(["node", "--version"], env=env, capture_output=True, text=True, check=True)
        npm_version = subprocess.run(["npm", "--version"], env=env, capture_output=True, text=True, check=True)
        print(f"Verified Node.js: {node_version.stdout.strip()}")
        print(f"Verified npm: {npm_version.stdout.strip()}")
    except (subprocess.CalledProcessError, FileNotFoundError) as e:
        print(f"Failed to verify Node.js/npm: {e}")
        return False

    sdk_path = os.path.join(repo_root, "clients", "typescript", "agentic-sandbox-client")

    print(f"Installing TypeScript SDK dependencies at {sdk_path}")
    result = subprocess.run(["npm", "install"], cwd=sdk_path, env=env, check=False)
    if result.returncode != 0:
        print("Failed to install TypeScript SDK dependencies.")
        return False

    print("Building TypeScript SDK...")
    result = subprocess.run(["npm", "run", "build"], cwd=sdk_path, env=env, check=False)
    if result.returncode != 0:
        print("Failed to build TypeScript SDK.")
        return False

    print("TypeScript SDK built successfully.")
    return True


def run_typescript_e2e_tests(repo_root, artifact_dir, env):
    """Runs the TypeScript SDK E2E tests"""
    print("========= Running TypeScript SDK E2E tests... =========")
    e2e_dir = os.path.join(repo_root, "test", "e2e", "clients", "typescript")

    print(f"Installing test dependencies at {e2e_dir}")
    result = subprocess.run(["npm", "install"], cwd=e2e_dir, env=env, check=False)
    if result.returncode != 0:
        print("Failed to install TypeScript E2E test dependencies.")
        return result.returncode

    junit_report_path = os.path.join(repo_root, "bin", "e2e-ts-sdk-junit.xml")
    vitest_cmd = [
        "npx", "vitest", "run",
        "--reporter=junit",
        f"--outputFile={junit_report_path}",
    ]

    print(f"Running command: {' '.join(vitest_cmd)}")
    result = subprocess.run(vitest_cmd, cwd=e2e_dir, env=env)
    return result.returncode


def run_python_e2e_tests(repo_root, artifact_dir, env):
    """Runs the Python e2e tests and generates a junit report"""
    print("========= Running Python SDK E2E tests... =========")

    # Define the path for the JUnit report
    junit_report_path = f"{repo_root}/bin/e2e-python-sdk-junit.xml"

    # Set the environment variable for the test namespace
    test_env = env.copy()

    python_executable = os.path.join(repo_root, ".venv", "bin", "python")
    pytest_cmd = [
        python_executable,
        "-m",
        "pytest",
        f"--junitxml={junit_report_path}",
        "-v",
        "-n", "auto",  # to run tests in parallel
        os.path.join(repo_root, "test", "e2e/"),
    ]

    print(f"Running command: {' '.join(pytest_cmd)}")
    result = subprocess.run(pytest_cmd, env=test_env, cwd=repo_root)
    return result.returncode


def main(args):
    """ invokes unit tests and outputs a junit results file """
    repo_root = utils.get_repo_root()

    artifact_dir = os.getenv("ARTIFACTS")
    if not artifact_dir:
        artifact_dir = f"{repo_root}/bin"
    os.makedirs(artifact_dir, exist_ok=True)

    env = os.environ.copy()
    env["IMAGE_TAG"] = utils.get_image_tag()
    env["IMAGE_PREFIX"] = utils.get_image_prefix(args)

    if not setup_python_sdk(repo_root, env):
        return 1

    if not setup_typescript_sdk(repo_root, env):
        return 1

    exit_code = 0

    go_test_result = run_go_e2e_tests(repo_root, artifact_dir, env)
    go_benchmark_result = run_go_e2e_benchmarks(repo_root, artifact_dir, env)
    python_test_result = run_python_e2e_tests(repo_root, artifact_dir, env)
    typescript_test_result = run_typescript_e2e_tests(repo_root, artifact_dir, env)

    if go_test_result != 0:
        print("Go E2E tests failed.")

    if go_benchmark_result != 0:
        print("Go E2E benchmarks failed.")

    if python_test_result != 0:
        print("Python SDK E2E tests failed.")
        exit_code = 1

    if typescript_test_result != 0:
        print("TypeScript SDK E2E tests failed.")
        exit_code = 1

    if go_test_result != 0 or python_test_result != 0 or go_benchmark_result != 0 or typescript_test_result != 0:
        print("One or more E2E tests failed.")
        exit_code = 1

    return exit_code


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Run end-to-end tests against Kubernetes kind cluster"
    )
    parser.add_argument(
        "--image-prefix",
        dest="image_prefix",
        help="prefix for the image name. requires slash at the end if a path",
        type=str,
        default=os.getenv("IMAGE_PREFIX"),
    )
    args = parser.parse_args()
    sys.exit(main(args))
