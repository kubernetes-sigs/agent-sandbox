#!/usr/bin/env python3
# Copyright 2025 The Kubernetes Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import os
import re
import argparse
import subprocess

def main():
    parser = argparse.ArgumentParser(description='Generate release manifests.')
    parser.add_argument('--tag', required=True, help='The git tag for the release.')
    args = parser.parse_args()

    # Create the release_assets directory if it doesn't exist
    if not os.path.exists('release_assets'):
        os.makedirs('release_assets')

    image_url = f'registry.k8s.io/agent-sandbox/agent-sandbox-controller:{args.tag}'
    
    # --- Kustomize build paths ---
    base_dir = "k8s/base"
    extensions_dir = "k8s/overlays/extensions"
    
    # --- Output file paths ---
    base_output_file = 'release_assets/manifest.yaml'
    extensions_output_file = 'release_assets/extensions.yaml'

    try:
        # --- Generate manifest.yaml (Base) ---
        print(f'INFO: Building base manifest from {base_dir}')
        cmd_base = ["kustomize", "build", base_dir]
        result_base = subprocess.run(cmd_base, capture_output=True, check=True, text=True)
        filedata_base = result_base.stdout
        
        print(f'INFO: Replacing image placeholder in base manifest.yaml with: {image_url}')
        filedata_base = re.sub(r'ko://sigs.k8s.io/agent-sandbox/cmd/agent-sandbox-controller.*', image_url, filedata_base)

        with open(base_output_file, 'w') as file:
            file.write(filedata_base)
        print(f'INFO: Successfully created {base_output_file}')

        # --- Generate extensions.yaml (Overlay) ---
        print(f'INFO: Building extensions manifest from {extensions_dir}')
        cmd_ext = ["kustomize", "build", extensions_dir]
        result_ext = subprocess.run(cmd_ext, capture_output=True, check=True, text=True)
        filedata_ext = result_ext.stdout

        print(f'INFO: Replacing image placeholder in extensions.yaml with: {image_url}')
        filedata_ext = re.sub(r'ko://sigs.k8s.io/agent-sandbox/cmd/agent-sandbox-controller.*', image_url, filedata_ext)

        with open(extensions_output_file, 'w') as file:
            file.write(filedata_ext)
        print(f'INFO: Successfully created {extensions_output_file}')

    except FileNotFoundError:
        print("Error: 'kustomize' command not found. Please ensure it's installed and in your PATH.")
        exit(1) # Fail the build
    except subprocess.CalledProcessError as e:
        print(f"Error running kustomize: {e.stderr}")
        exit(1) # Fail the build

if __name__ == '__main__':
    main()