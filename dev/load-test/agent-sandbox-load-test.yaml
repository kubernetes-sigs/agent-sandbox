{{$replicas := DefaultParam .CL2_REPLICAS 20}}
{{$namespacePrefix := DefaultParam .CL2_NAMESPACE_PREFIX "agent-sandbox"}}
name: agent-sandbox-load-test
namespace:
  number: 1
  prefix: {{$namespacePrefix}}
tuningSets:
- name: BurstCreate
  qpsLoad:
    qps: 10 # Adjust based on your cluster's capacity
steps:
- name: Start Startup Latency Measurement
  measurements:
  - Identifier: SandboxStartupLatency
    Method: PodStartupLatency # We use Pod latency as Sandboxes wrap Pods
    Params:
      action: start
      labelSelector: "agents.x-k8s.io/sandbox-name-hash"
      namespace: {{$namespacePrefix}}-1
- name: Create Sandboxes
  phases:
  - namespaceRange: {min: 1, max: 1}
    replicasPerNamespace: {{$replicas}} # Total sandboxes to spin up
    tuningSet: BurstCreate
    objectBundle:
    - basename: agent-env
      objectTemplatePath: "cluster-loader-sandbox.yaml"
- name: Wait for Sandboxes to be Ready
  measurements:
  - Identifier: WaitForSandboxes
    Method: WaitForRunningPods
    Params:
      action: start
      labelSelector: "agents.x-k8s.io/sandbox-name-hash"
      namespace: {{$namespacePrefix}}-1
      desiredPodCount: {{$replicas}}
- name: Gather Results
  measurements:
  - Identifier: SandboxStartupLatency
    Method: PodStartupLatency
    Params:
      action: gather
      namespace: {{$namespacePrefix}}-1
      labelSelector: "agents.x-k8s.io/sandbox-name-hash"
- name: Delete Sandboxes
  phases:
  - namespaceRange: {min: 1, max: 1}
    replicasPerNamespace: 0
    tuningSet: BurstCreate
    objectBundle:
    - basename: agent-env
      objectTemplatePath: "cluster-loader-sandbox.yaml"